#!/usr/bin/env python3
"""
Skill: vulnerability-scanner
Script: smoke_checks.py
Purpose: Dynamic security smoke checks against a deployed environment
Usage: python smoke_checks.py <url>
"""
import sys
import argparse
import urllib.request
import ssl
import json

def check_headers(url: str):
    print(f"Checking headers for: {url}")
    results = {"passed": True, "findings": []}
    
    try:
        # Create unverified context to avoid cert errors in some test envs
        ctx = ssl.create_default_context()
        ctx.check_hostname = False
        ctx.verify_mode = ssl.CERT_NONE
        
        req = urllib.request.Request(url)
        with urllib.request.urlopen(req, context=ctx, timeout=10) as response:
            headers = response.info()
            
            # 1. CSP
            if 'Content-Security-Policy' not in headers:
                results["findings"].append("Missing Content-Security-Policy header")
                results["passed"] = False
            
            # 2. HSTS
            if 'Strict-Transport-Security' not in headers and url.startswith("https"):
                results["findings"].append("Missing Strict-Transport-Security header")
                # Warning only for now as it might be handled by proxy
            
            # 3. X-Frame-Options
            if 'X-Frame-Options' not in headers:
                results["findings"].append("Missing X-Frame-Options header")
                results["passed"] = False
            
            # 4. X-Content-Type-Options
            if 'X-Content-Type-Options' not in headers:
                results["findings"].append("Missing X-Content-Type-Options header")
                results["passed"] = False
                
    except Exception as e:
        results["passed"] = False
        results["findings"].append(f"Connection failed: {str(e)}")
    
    return results

def main():
    parser = argparse.ArgumentParser(description="Run security smoke checks")
    parser.add_argument("url", help="Target URL")
    args = parser.parse_args()
    
    if not args.url.startswith("http"):
        print("Error: URL must start with http:// or https://")
        sys.exit(1)
        
    result = check_headers(args.url)
    
    if result["passed"]:
        print("[PASS] Smoke checks passed")
        sys.exit(0)
    else:
        print("[FAIL] Smoke checks failed:")
        for finding in result["findings"]:
            print(f"  - {finding}")
        sys.exit(1)

if __name__ == "__main__":
    main()
